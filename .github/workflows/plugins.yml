permissions:
  contents: write

name: Build Plugins

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.14
      uses: actions/setup-python@v5
      with:
        python-version: '3.14-dev' # Or '3.13' if 3.14 isn't in the runner yet

    - name: Install LLVM/Clang
      run: choco install llvm -y

    - name: Build Plugins and Runtime
      shell: cmd
      run: |
        set PY_INCLUDE=%pythonLocation%\include
        set PY_LIB=%pythonLocation%\libs
        
        set OPTS=-std=c++20 --target=x86_64-pc-windows-msvc

        cd plugins
        clang++.exe %OPTS% -shared -o console.dll console.cc
        clang++.exe %OPTS% -shared -o heartbeat.dll heartbeat.cc
        clang++.exe %OPTS% -shared -o logger.dll logger.cc
        
        clang++.exe %OPTS% -shared -o python.dll python.cc ..\ini.cc -I"%PY_INCLUDE%" -L"%PY_LIB%" -lpython314

        cd ..
        clang++.exe %OPTS% -o runtime.exe runtime.cc ini.cc

    - name: Upload Binaries
      uses: actions/upload-artifact@v4
      with:
        name: plugin-pack
        path: |
          plugins/*.dll
          runtime.exe

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          plugins/python.dll
          plugins/console.dll
          plugins/heartbeat.dll
          plugins/logger.dll
          runtime.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
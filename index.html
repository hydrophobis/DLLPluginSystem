<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLLPluginSystem Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body class="bg-gray-900 text-white font-sans antialiased">

    <header class="py-10 bg-gray-800 shadow-2xl border-b border-gray-700 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-6 text-center">
            <h1 class="text-4xl font-extrabold text-blue-400 tracking-tight">Plugin Gallery</h1>
            <p class="text-gray-400 mt-2 mb-8">Central Repository for DLLPluginSystem Modules</p>
            
            <div class="flex flex-col md:flex-row gap-4 justify-center items-center">
                <div class="relative w-full md:w-96">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                    <input type="text" id="search-input" placeholder="Search plugins..." 
                           class="w-full bg-gray-950 border border-gray-700 rounded-xl py-3 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <select id="filter-type" class="w-full md:w-auto bg-gray-950 border border-gray-700 rounded-xl py-3 px-6 focus:outline-none focus:ring-2 focus:ring-blue-500 transition cursor-pointer">
                    <option value="all">All Platforms</option>
                    <option value="DLL">Windows (.dll)</option>
                    <option value="Python">Python (.py)</option>
                </select>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-6">
        <div id="plugin-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="col-span-full py-20 text-center">
                <i class="fas fa-circle-notch animate-spin text-4xl text-blue-500"></i>
                <p class="mt-4 text-gray-500">Fetching latest modules...</p>
            </div>
        </div>
    </main>

    <script>
        let allPlugins = [];

        async function init() {
            try {
                const response = await fetch('catalog.json');
                const data = await response.json();
                allPlugins = data.plugins;
                renderPlugins(allPlugins);
                
                document.getElementById('search-input').addEventListener('input', handleFilter);
                document.getElementById('filter-type').addEventListener('change', handleFilter);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('plugin-list').innerHTML = `<div class="col-span-full text-center text-red-400 p-10 border border-red-900 rounded-xl bg-red-900/10">Failed to load catalog.</div>`;
            }
        }

        function getPluginById(id) {
            return allPlugins.find(p => p.id === id);
        }

        function resolveDependencies(pluginId, resolved = new Set()) {
            const plugin = getPluginById(pluginId);
            if (!plugin || !plugin.dependencies) return resolved;

            plugin.dependencies.forEach(dep => {
                if (!resolved.has(dep.id)) {
                    resolved.add(dep.id);
                    resolveDependencies(dep.id, resolved);
                }
            });
            return resolved;
        }

        function handleFilter() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const typeFilter = document.getElementById('filter-type').value;
            const filtered = allPlugins.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(searchTerm) || p.description.toLowerCase().includes(searchTerm);
                const matchesType = typeFilter === 'all' || p.type === typeFilter;
                return matchesSearch && matchesType;
            });
            renderPlugins(filtered);
        }

        function renderPlugins(plugins) {
            const container = document.getElementById('plugin-list');
            container.innerHTML = '';

            plugins.forEach(plugin => {
                const typeStyles = {
                    'Python': { icon: 'fab fa-python', color: 'text-blue-400', bg: 'bg-blue-900/30' },
                    'DLL': { icon: 'fas fa-window-maximize', color: 'text-gray-300', bg: 'bg-gray-700/50' }
                };
                const style = typeStyles[plugin.type] || { icon: 'fas fa-puzzle-piece', color: 'text-gray-400', bg: 'bg-gray-800' };

                let depHtml = '';
                if (plugin.dependencies?.length > 0) {
                    depHtml = `<div class="mt-4 pt-4 border-t border-gray-700/50">
                        <p class="text-[10px] font-bold text-gray-500 uppercase mb-2">Depends On</p>
                        <div class="flex flex-wrap gap-2">
                            ${plugin.dependencies.map(dep => {
                                const d = getPluginById(dep.id);
                                return `<span class="text-[10px] px-2 py-0.5 rounded border ${dep.required ? 'border-red-900/50 text-red-400 bg-red-900/10' : 'border-gray-700 text-gray-400 bg-gray-800'}">
                                    ${dep.required ? 'â˜… ' : ''}${d ? d.name : dep.id}
                                </span>`;
                            }).join('')}
                        </div>
                    </div>`;
                }

                container.innerHTML += `
                    <div class="bg-gray-800 flex flex-col rounded-2xl border border-gray-700 hover:border-blue-500/40 transition-all overflow-hidden group">
                        <div class="p-6 flex-grow">
                            <div class="flex justify-between items-start mb-3">
                                <h2 class="text-xl font-bold group-hover:text-blue-300 transition-colors">${plugin.name}</h2>
                                <span class="${style.bg} ${style.color} text-[10px] px-2 py-1 rounded-md font-bold uppercase tracking-widest flex items-center">
                                    <i class="${style.icon} mr-1.5"></i>${plugin.type}
                                </span>
                            </div>
                            <p class="text-gray-400 text-sm line-clamp-3 leading-relaxed">${plugin.description}</p>
                            ${depHtml}
                        </div>
                        <div class="px-6 pb-6 mt-auto">
                            <div class="flex flex-col gap-3">
                                <div class="flex items-center justify-between">
                                     <div class="flex items-center text-gray-500 text-xs">
                                        <i class="fas fa-user-circle mr-1.5"></i>
                                        <span class="font-medium truncate max-w-[120px]">${plugin.author}</span>
                                    </div>
                                    <select id="select-${plugin.id}" class="bg-gray-900 border border-gray-700 rounded-lg py-1 px-2 text-xs text-blue-400 focus:outline-none cursor-pointer">
                                        ${plugin.releases.map(r => `<option value="${r.url}">${r.version}</option>`).join('')}
                                    </select>
                                </div>
                                <button onclick="downloadWithCheck('${plugin.id}')" 
                                        class="w-full bg-blue-600 hover:bg-blue-500 py-2.5 rounded-xl text-sm font-bold transition transform active:scale-95 flex justify-center items-center gap-2">
                                    <i class="fas fa-download"></i> Get Plugin
                                </button>
                            </div>
                        </div>
                    </div>`;
            });
        }

        function downloadWithCheck(id) {
            const plugin = getPluginById(id);
            const depIds = resolveDependencies(id);
            const requiredDeps = [];
            
            depIds.forEach(depId => {
                const depPlugin = getPluginById(depId);
                requiredDeps.push(depPlugin ? depPlugin.name : depId);
            });

            if (requiredDeps.length > 0) {
                const proceed = confirm(`${plugin.name} requires the following to be installed:\n\n- ${requiredDeps.join('\n- ')}\n\nProceed to download?`);
                if (!proceed) return;
            }

            const url = document.getElementById(`select-${id}`).value;
            window.location.href = url;
        }

        init();
    </script>
</body>
</html>